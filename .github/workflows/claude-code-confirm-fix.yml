name: Claude Code - ç¡®è®¤ä¿®å¤æŒ‡ä»¤

on:
  issue_comment:
    types: [created]

permissions:
  issues: write

jobs:
  detect-confirmation:
    # åªåœ¨ issue è¯„è®ºæ—¶è§¦å‘ï¼Œä¸åœ¨ PR è¯„è®ºæ—¶è§¦å‘
    if: |
      github.event.issue.pull_request == null &&
      github.event.comment.user.type != 'Bot'

    runs-on: ubuntu-latest

    steps:
      - name: æ£€æµ‹ç¡®è®¤æŒ‡ä»¤
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const comment = context.payload.comment.body.toLowerCase().trim();
            const issueNumber = context.payload.issue.number;

            // æ£€æµ‹ç¡®è®¤æŒ‡ä»¤ï¼ˆåªä¿ç•™æ˜ç¡®çš„æŒ‡ä»¤ï¼‰
            const confirmKeywords = [
              '/confirm-fix',
              '/approve'
            ];

            const isConfirmation = confirmKeywords.some(keyword =>
              comment.includes(keyword.toLowerCase())
            );

            if (!isConfirmation) {
              console.log('è¯„è®ºä¸åŒ…å«ç¡®è®¤æŒ‡ä»¤ï¼Œè·³è¿‡å¤„ç†');
              return;
            }

            // è·å–å½“å‰ issue çš„æ ‡ç­¾
            const { data: issue } = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
            });

            const labels = issue.labels.map(label => label.name);

            // æ£€æŸ¥æ˜¯å¦å·²æœ‰å¿…éœ€çš„æ ‡ç­¾
            const hasAutoFixApproved = labels.includes('auto-fix-approved');
            const hasAiSafe = labels.includes('ai-safe');
            const hasFixConfirmed = labels.includes('fix-confirmed');

            if (!hasAutoFixApproved || !hasAiSafe) {
              // æ²¡æœ‰å¿…éœ€çš„æ ‡ç­¾ï¼Œæç¤ºç”¨æˆ·
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: 'âš ï¸ æ­¤ issue å°šæœªè·å¾—è‡ªåŠ¨ä¿®å¤æ‰¹å‡†ã€‚\n\néœ€è¦ç»´æŠ¤è€…æ·»åŠ ä»¥ä¸‹æ ‡ç­¾æ‰èƒ½å¯ç”¨è‡ªåŠ¨ä¿®å¤ï¼š\n- `auto-fix-approved` - æ‰¹å‡†è‡ªåŠ¨ä¿®å¤\n- `ai-safe` - ç¡®è®¤è¿™æ˜¯ç®€å•å®‰å…¨çš„é—®é¢˜\n\nè¯·è”ç³»ç»´æŠ¤è€…å®¡æ‰¹ã€‚',
              });
              return;
            }

            if (hasFixConfirmed) {
              // å·²ç»ç¡®è®¤è¿‡äº†
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: 'âœ… æ­¤ä¿®å¤æ–¹æ¡ˆå·²ç»ç¡®è®¤ï¼Œä¿®å¤å·¥ä½œæµåº”è¯¥æ­£åœ¨è¿è¡Œæˆ–å·²å®Œæˆã€‚\n\nè¯·æŸ¥çœ‹ [Actions](../../actions) é¡µé¢äº†è§£ä¿®å¤è¿›åº¦ã€‚',
              });
              return;
            }

            // æ·»åŠ  fix-confirmed æ ‡ç­¾
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              labels: ['fix-confirmed'],
            });

            // å‘é€ç¡®è®¤æ¶ˆæ¯
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: 'âœ… å·²ç¡®è®¤ä¿®å¤æ–¹æ¡ˆï¼\n\nğŸ¤– è‡ªåŠ¨ä¿®å¤å·¥ä½œæµå³å°†å¯åŠ¨ï¼Œæˆ‘ä¼šï¼š\n1. åˆ›å»ºä¿®å¤åˆ†æ”¯ `auto-fix/issue-' + issueNumber + '`\n2. æŒ‰ç…§æ–¹æ¡ˆè¿›è¡Œä¿®å¤\n3. è¿è¡ŒéªŒè¯æµ‹è¯•\n4. åˆ›å»ºè‰ç¨¿ PR\n\nè¯·ç¨å€™ï¼Œä½ å¯ä»¥åœ¨ [Actions](../../actions) é¡µé¢æŸ¥çœ‹è¿›åº¦ã€‚',
            });
