name: Claude Code - PR å®¡æŸ¥

on:
  pull_request:
    types: [opened, synchronize, reopened]
  # ä¹Ÿæ”¯æŒè¯„è®ºè§¦å‘
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  claude-review:
    # ä»…å½“æ˜¯ PR è¯„è®ºä¸”åŒ…å« @claude
    if: |
      github.event_name == 'pull_request' ||
      (github.event.issue.pull_request && contains(github.event.comment.body, '@claude'))

    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²

      - name: è¿è¡Œ Claude Code å®¡æŸ¥
        id: pr_review
        uses: anthropics/claude-code-action@v1
        env:
          # æ”¯æŒè‡ªå®šä¹‰ Anthropic API Base URL
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

          # ä½¿ç”¨é¡¹ç›®çš„ code-audit skill
          prompt: |
            è¯·ç”¨ /code-audit å®¡æŸ¥è¿™ä¸ª PR çš„æ”¹åŠ¨ã€‚

            é‡ç‚¹å…³æ³¨ï¼š
            1. Next.js 15 æœ€ä½³å®è·µ
            2. ä»£ç é‡å¤å’Œå¤ç”¨æ€§
            3. ç»„ä»¶ä¸€è‡´æ€§
            4. æ— æ•ˆä»£ç æ¸…ç†

            ç”Ÿæˆè¯¦ç»†çš„å®¡æŸ¥æŠ¥å‘Šã€‚

          # Claude Code CLI å‚æ•°
          claude_args: "--max-turns 5"

      - name: å¤„ç†å®¡æŸ¥å¤±è´¥
        if: failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // è·å– PR ç¼–å·
            const prNumber = context.payload.pull_request?.number || context.payload.issue?.number;

            if (!prNumber) {
              console.log('æ— æ³•ç¡®å®š PR ç¼–å·');
              return;
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: [
                'âŒ **PR ä»£ç å®¡æŸ¥å¤±è´¥**',
                '',
                'æŠ±æ­‰ï¼Œå®¡æŸ¥æ­¤ PR æ—¶é‡åˆ°äº†é—®é¢˜ã€‚',
                '',
                '**å¯èƒ½çš„åŸå› **ï¼š',
                '- PR æ”¹åŠ¨è¿‡å¤§æˆ–è¿‡äºå¤æ‚',
                '- ä»£ç åº“è®¿é—®æƒé™ä¸è¶³',
                '- API è°ƒç”¨å¤±è´¥æˆ–è¶…æ—¶',
                '',
                '**å»ºè®®**ï¼š',
                '- è¯·æŸ¥çœ‹ [Actions è¿è¡Œæ—¥å¿—](' + context.payload.repository.html_url + '/actions/runs/' + context.runId + ') äº†è§£è¯¦æƒ…',
                '- å°è¯•æ‹†åˆ† PR ä¸ºå¤šä¸ªè¾ƒå°çš„æ”¹åŠ¨',
                '- æˆ–æ‰‹åŠ¨è¿›è¡Œä»£ç å®¡æŸ¥',
                '',
                '---',
                'ğŸ¤– GitHub Actions è‡ªåŠ¨é€šçŸ¥'
              ].join('\n')
            });

      # æ³¨æ„ï¼šClaude Code Action ä¼šè‡ªåŠ¨å‘å¸ƒè¯„è®ºåˆ° PR
      # ä¸éœ€è¦é¢å¤–çš„æ­¥éª¤æ¥åˆ›å»ºè¯„è®º
