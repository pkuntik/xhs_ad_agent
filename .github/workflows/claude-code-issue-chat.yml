name: Claude Code - Issue 对话

on:
  issue_comment:
    types: [created]

permissions:
  issues: write
  contents: read
  id-token: write


jobs:
  chat:
    runs-on: ubuntu-latest
    # 只在 issue 评论时触发，不在 PR 评论时触发，且评论者不是 bot
    if: |
      github.event.issue.pull_request == null &&
      github.event.comment.user.type != 'Bot' &&
      github.event.sender.login != 'github-actions[bot]'

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 获取历史评论
        id: get_comments
        run: |
          COMMENTS=$(gh issue view ${{ github.event.issue.number }} --json comments --jq '.comments | map("**@" + .author.login + "** (" + .createdAt + "):\n" + .body) | join("\n\n---\n\n")')
          echo "comments<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMENTS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Claude 回复 Issue 评论
        uses: anthropics/claude-code-action@v1
        env:
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

          prompt: |
            你是这个仓库的 AI 助手，正在帮助用户解决 issue #${{ github.event.issue.number }}。

            **Issue 标题**: ${{ github.event.issue.title }}

            **Issue 描述**:
            ${{ github.event.issue.body }}

            **历史评论**:
            ${{ steps.get_comments.outputs.comments }}

            **最新评论来自** @${{ github.event.comment.user.login }}:
            ${{ github.event.comment.body }}

            请根据评论内容：
            1. 如果用户在询问问题，提供详细的解答（参考 issue 描述和历史讨论）
            2. 如果用户在讨论解决方案，提供专业建议
            3. 如果用户请求修复，说明你需要维护者添加 `auto-fix-approved` 和 `ai-safe` 标签才能开始自动修复
            4. 如果用户提供了额外信息，确认收到并更新你的理解
            5. 注意上下文，理解完整的讨论历史

            **可用工具**:
            - 使用 Read/Grep/Glob 查看代码
            - 使用 gh 命令查看其他 issues、创建 PR、更新标签等
            - 你的文本回复会自动作为评论发布到 issue

            **重要限制**:
            - 不要使用 `gh issue comment` 发表评论（你的回复会自动发布）
            - 不要修改代码或提交代码（这应该在本地或其他工作流中完成）

          claude_args: "--max-turns 10 --allowed-tools Read,Grep,Glob,Bash"
