name: Claude Code - Issue å¯¹è¯

on:
  issue_comment:
    types: [created]

permissions:
  issues: write
  contents: read
  id-token: write


jobs:
  chat:
    runs-on: ubuntu-latest
    # åªåœ¨ issue è¯„è®ºæ—¶è§¦å‘ï¼Œä¸åœ¨ PR è¯„è®ºæ—¶è§¦å‘ï¼Œä¸”è¯„è®ºè€…ä¸æ˜¯ bot
    # æ’é™¤æ˜ç¡®çš„ç¡®è®¤æŒ‡ä»¤ï¼ˆç”± confirm-fix å·¥ä½œæµå¤„ç†ï¼‰
    if: |
      github.event.issue.pull_request == null &&
      github.event.comment.user.type != 'Bot' &&
      github.event.sender.login != 'github-actions[bot]' &&
      !contains(github.event.comment.body, '/confirm-fix') &&
      !contains(github.event.comment.body, '/approve')

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è·å–å†å²è¯„è®º
        id: get_comments
        run: |
          COMMENTS=$(gh issue view ${{ github.event.issue.number }} --json comments --jq '.comments | map("**@" + .author.login + "** (" + .createdAt + "):\n" + .body) | join("\n\n---\n\n")')
          echo "comments<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMENTS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Claude å›å¤ Issue è¯„è®º
        id: claude_chat
        uses: anthropics/claude-code-action@v1
        env:
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

          prompt: |
            ä½ æ˜¯è¿™ä¸ªä»“åº“çš„ AI åŠ©æ‰‹ï¼Œæ­£åœ¨å¸®åŠ©ç”¨æˆ·è§£å†³ issue #${{ github.event.issue.number }}ã€‚

            **Issue æ ‡é¢˜**: ${{ github.event.issue.title }}

            **Issue æè¿°**:
            ${{ github.event.issue.body }}

            **å†å²è¯„è®º**:
            ${{ steps.get_comments.outputs.comments }}

            **æœ€æ–°è¯„è®ºæ¥è‡ª** @${{ github.event.comment.user.login }}:
            ${{ github.event.comment.body }}

            è¯·æ ¹æ®è¯„è®ºå†…å®¹ï¼š
            1. å¦‚æœç”¨æˆ·åœ¨è¯¢é—®é—®é¢˜ï¼Œæä¾›è¯¦ç»†çš„è§£ç­”ï¼ˆå‚è€ƒ issue æè¿°å’Œå†å²è®¨è®ºï¼‰
            2. å¦‚æœç”¨æˆ·åœ¨è®¨è®ºè§£å†³æ–¹æ¡ˆï¼Œæä¾›ä¸“ä¸šå»ºè®®
            3. å¦‚æœç”¨æˆ·æä¾›äº†é¢å¤–ä¿¡æ¯ï¼Œç¡®è®¤æ”¶åˆ°å¹¶æ›´æ–°ä½ çš„ç†è§£
            4. æ³¨æ„ä¸Šä¸‹æ–‡ï¼Œç†è§£å®Œæ•´çš„è®¨è®ºå†å²

            **å¤„ç†ä¿®å¤è¯·æ±‚**:
            å¦‚æœç”¨æˆ·æ˜ç¡®è¡¨ç¤ºè¦ä¿®å¤ï¼ˆå¦‚"ä¿®"ã€"åŒæ„ä¿®å¤"ã€"å¼€å§‹ä¿®å¤"ç­‰ï¼‰ï¼Œä½ éœ€è¦ï¼š
            1. æ£€æŸ¥ issue æ˜¯å¦æœ‰ `auto-fix-approved` å’Œ `ai-safe` æ ‡ç­¾
            2. å¦‚æœæœ‰è¿™ä¸¤ä¸ªæ ‡ç­¾ï¼š
               - ä½¿ç”¨ `gh issue edit ${{ github.event.issue.number }} --add-label "fix-confirmed"` æ·»åŠ ç¡®è®¤æ ‡ç­¾
               - å›å¤ï¼š"âœ… å·²ç¡®è®¤ä¿®å¤æ–¹æ¡ˆï¼è‡ªåŠ¨ä¿®å¤å·¥ä½œæµå³å°†å¯åŠ¨ã€‚"
            3. å¦‚æœæ²¡æœ‰è¿™ä¸¤ä¸ªæ ‡ç­¾ï¼š
               - å›å¤ï¼š"æ”¶åˆ°ä¿®å¤è¯·æ±‚ã€‚éœ€è¦ç»´æŠ¤è€…æ·»åŠ  `auto-fix-approved` å’Œ `ai-safe` æ ‡ç­¾åæ‰èƒ½å¼€å§‹è‡ªåŠ¨ä¿®å¤ã€‚"

            **ä¸è¦è‡ªå·±å°è¯•ä¿®å¤ä»£ç **ï¼ä½ çš„èŒè´£æ˜¯ï¼š
            - å›ç­”é—®é¢˜å’Œæä¾›å»ºè®®
            - å¼•å¯¼ç”¨æˆ·ä½¿ç”¨è‡ªåŠ¨ä¿®å¤å·¥ä½œæµ
            - æ£€æŸ¥æ ‡ç­¾å¹¶è§¦å‘ä¿®å¤ï¼ˆé€šè¿‡æ·»åŠ  fix-confirmed æ ‡ç­¾ï¼‰

            **å›å¤æ–¹å¼**:
            ä½¿ç”¨ `gh issue comment ${{ github.event.issue.number }} --body "ä½ çš„å›å¤å†…å®¹"` æ¥å‘å¸ƒè¯„è®º

            **å¯ç”¨å·¥å…·**:
            - Read/Grep/Glob æŸ¥çœ‹ä»£ç 
            - Bash æ‰§è¡Œå‘½ä»¤ï¼ˆåŒ…æ‹¬ gh å‘½ä»¤ç®¡ç† issuesã€PRã€æ ‡ç­¾ç­‰ï¼‰

          claude_args: "--max-turns 15 --allowed-tools Read,Grep,Glob,Bash"

      - name: å¤„ç†æ‰§è¡Œå¤±è´¥
        if: failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = context.payload.issue.number;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: [
                'âŒ **AI å›å¤å¤±è´¥**',
                '',
                'æŠ±æ­‰ï¼Œå¤„ç†æ‚¨çš„è¯„è®ºæ—¶é‡åˆ°äº†é—®é¢˜ã€‚',
                '',
                '**å¯èƒ½çš„åŸå› **ï¼š',
                '- AI æ‰§è¡Œè¶…æ—¶ï¼ˆè¶…è¿‡ 15 è½®å¯¹è¯ï¼‰',
                '- API è°ƒç”¨å¤±è´¥',
                '- æƒé™ä¸è¶³',
                '',
                '**å»ºè®®**ï¼š',
                '- è¯·æŸ¥çœ‹ [Actions è¿è¡Œæ—¥å¿—](' + context.payload.repository.html_url + '/actions/runs/' + context.runId + ') äº†è§£è¯¦æƒ…',
                '- å¦‚æœé—®é¢˜æŒç»­ï¼Œè¯·ç®€åŒ–æ‚¨çš„è¯·æ±‚æˆ–åˆ†æ­¥æé—®',
                '- å¯¹äºå¤æ‚é—®é¢˜ï¼Œå»ºè®®ä½¿ç”¨æ˜ç¡®çš„æŒ‡ä»¤ï¼ˆå¦‚ `/confirm-fix`ï¼‰',
                '',
                '---',
                'ğŸ¤– GitHub Actions è‡ªåŠ¨é€šçŸ¥'
              ].join('\n')
            });
