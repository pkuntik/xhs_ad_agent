name: Claude Code - å®‰å…¨è‡ªåŠ¨ä¿®å¤

on:
  issues:
    types: [labeled]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  # ç¬¬ä¸€é˜¶æ®µï¼šè¯„è®ºä¿®å¤æ–¹æ¡ˆ
  propose-fix:
    # ğŸ”’ æ¡ä»¶ï¼šæœ‰ 'auto-fix-approved' å’Œ 'ai-safe'ï¼Œä½†æ²¡æœ‰ 'fix-confirmed'
    if: |
      contains(github.event.issue.labels.*.name, 'auto-fix-approved') &&
      contains(github.event.issue.labels.*.name, 'ai-safe') &&
      !contains(github.event.issue.labels.*.name, 'fix-confirmed')

    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: Claude åˆ†æå¹¶æå‡ºä¿®å¤æ–¹æ¡ˆ
        uses: anthropics/claude-code-action@v1
        env:
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

          prompt: |
            ä½ æ˜¯è‡ªåŠ¨ä¿®å¤æœºå™¨äººã€‚

            å½“å‰ issue: #${{ github.event.issue.number }}

            **ä»»åŠ¡ï¼šåˆ†æé—®é¢˜å¹¶æå‡ºä¿®å¤æ–¹æ¡ˆ**

            è¯·ï¼š
            1. ä½¿ç”¨ gh issue view ${{ github.event.issue.number }} è¯»å– issue è¯¦æƒ…
            2. åˆ†æé—®é¢˜å¹¶åˆ¶å®šä¿®å¤æ–¹æ¡ˆ
            3. ä½¿ç”¨ gh issue comment ${{ github.event.issue.number }} --body "..." å‘å¸ƒè¯¦ç»†çš„ä¿®å¤æ–¹æ¡ˆ

            ä¿®å¤æ–¹æ¡ˆåº”åŒ…æ‹¬ï¼š
            - é—®é¢˜åˆ†æ
            - å…·ä½“ä¿®å¤æ­¥éª¤
            - å½±å“èŒƒå›´
            - é¢„æœŸæ•ˆæœ
            - é£é™©è¯„ä¼°

            åœ¨æ–¹æ¡ˆæœ«å°¾è¯´æ˜ï¼š
            ```
            **æ˜¯å¦åŒæ„æ­¤ä¿®å¤æ–¹æ¡ˆï¼Ÿ**

            å¦‚æœåŒæ„ï¼Œè¯·æ·»åŠ æ ‡ç­¾ `fix-confirmed`ï¼Œæˆ‘å°†è‡ªåŠ¨å¼€å§‹ä¿®å¤ã€‚
            å¦‚æœä¸åŒæ„ï¼Œè¯·ç§»é™¤ `auto-fix-approved` æ ‡ç­¾å¹¶è¯´æ˜è°ƒæ•´è¦æ±‚ã€‚
            ```

            âš ï¸ **é‡è¦**ï¼šæ­¤é˜¶æ®µåªæå‡ºæ–¹æ¡ˆï¼Œä¸è¦å®é™…ä¿®å¤ä»£ç ã€‚

          claude_args: "--max-turns 5 --allowed-tools Read,Grep,Glob,Bash"

  # ç¬¬äºŒé˜¶æ®µï¼šæ‰§è¡Œä¿®å¤
  execute-fix:
    # ğŸ”’ æ¡ä»¶ï¼šæœ‰å…¨éƒ¨ä¸‰ä¸ªæ ‡ç­¾ï¼ˆauto-fix-approved + ai-safe + fix-confirmedï¼‰
    if: |
      contains(github.event.issue.labels.*.name, 'auto-fix-approved') &&
      contains(github.event.issue.labels.*.name, 'ai-safe') &&
      contains(github.event.issue.labels.*.name, 'fix-confirmed')

    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: åˆ›å»ºä¿®å¤åˆ†æ”¯
        run: |
          ISSUE_NUM=${{ github.event.issue.number }}
          BRANCH_NAME="auto-fix/issue-${ISSUE_NUM}"
          git checkout -b "$BRANCH_NAME"
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Claude æ‰§è¡Œä¿®å¤
        uses: anthropics/claude-code-action@v1
        env:
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

          prompt: |
            ä½ æ˜¯è‡ªåŠ¨ä¿®å¤æœºå™¨äººã€‚

            å½“å‰ issue: #${{ github.event.issue.number }}

            **ä»»åŠ¡ï¼šæ‰§è¡Œå·²ç¡®è®¤çš„ä¿®å¤æ–¹æ¡ˆ**

            ç”¨æˆ·å·²ç»ç¡®è®¤äº†ä¿®å¤æ–¹æ¡ˆï¼ˆæœ‰ fix-confirmed æ ‡ç­¾ï¼‰ï¼Œç°åœ¨è¯·æ‰§è¡Œä¿®å¤ã€‚

            âš ï¸ **é‡è¦å®‰å…¨é™åˆ¶**ï¼š
            - åªèƒ½ä¿®å¤ import æ’åºã€ä»£ç æ ¼å¼åŒ–ç­‰**ç®€å•ã€ä½é£é™©**çš„é—®é¢˜
            - ä¸å¾—ä¿®æ”¹ä¸šåŠ¡é€»è¾‘
            - ä¸å¾—ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼ˆ.env, package.json ç­‰ï¼‰
            - ä¸å¾—åˆ é™¤è¶…è¿‡ 50 è¡Œä»£ç 
            - ä¸å¾—åˆ é™¤ console.logï¼ˆå¯èƒ½æ˜¯æœ‰æ„ä¿ç•™çš„ï¼‰

            è¯·ï¼š
            1. ä½¿ç”¨ gh issue view ${{ github.event.issue.number }} è¯»å– issue è¯¦æƒ…å’Œè¯„è®º
            2. æŸ¥çœ‹ä¹‹å‰åœ¨è¯„è®ºä¸­å‘å¸ƒçš„ä¿®å¤æ–¹æ¡ˆ
            3. æŒ‰ç…§æ–¹æ¡ˆè¿›è¡Œä¿®å¤
            4. ä¿®å¤åè¿è¡Œ `pnpm tsc --noEmit` éªŒè¯
            5. ä½¿ç”¨ git add å’Œ git commit æäº¤ä»£ç ï¼ˆä¸è¦ pushï¼Œç”±åç»­æ­¥éª¤å¤„ç†ï¼‰

            æäº¤ä¿¡æ¯æ ¼å¼ï¼š
            ```
            fix: [ç®€çŸ­æè¿°]

            Fixes #${{ github.event.issue.number }}

            ğŸ¤– ç”± Claude Code è‡ªåŠ¨ä¿®å¤
            ```

          claude_args: "--max-turns 10 --allowed-tools Read,Grep,Glob,Bash,Edit,Write"

      - name: æ¨é€åˆ†æ”¯
        run: |
          git push origin "$BRANCH_NAME" || echo "æ²¡æœ‰æ”¹åŠ¨éœ€è¦æ¨é€"

      - name: åˆ›å»º PRï¼ˆå¦‚æœæœ‰æ”¹åŠ¨ï¼‰
        if: success()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNum = ${{ github.event.issue.number }};
            const branchName = process.env.BRANCH_NAME;

            // æ£€æŸ¥åˆ†æ”¯æ˜¯å¦æœ‰æäº¤
            const { data: comparison } = await github.rest.repos.compareCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              base: 'main',
              head: branchName,
            });

            if (comparison.ahead_by === 0) {
              // æ²¡æœ‰æ”¹åŠ¨ï¼Œåœ¨ issue ä¸­è¯´æ˜
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNum,
                body: 'ğŸ¤– æˆ‘åˆ†æäº†è¿™ä¸ªé—®é¢˜ï¼Œä½†æ²¡æœ‰æ‰¾åˆ°å¯ä»¥è‡ªåŠ¨ä¿®å¤çš„ä»£ç ã€‚å¯èƒ½éœ€è¦äººå·¥å¤„ç†ã€‚',
              });
              return;
            }

            // åˆ›å»º PR
            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ¤– è‡ªåŠ¨ä¿®å¤: ${context.payload.issue.title}`,
              head: branchName,
              base: 'main',
              body: [
                '## è‡ªåŠ¨ä¿®å¤',
                '',
                `è¿™ä¸ª PR è‡ªåŠ¨ä¿®å¤äº† #${issueNum}ã€‚`,
                '',
                'âš ï¸ **è¯·ä»”ç»† Review**ï¼š',
                '- [ ] æ£€æŸ¥ä¿®å¤æ˜¯å¦æ­£ç¡®',
                '- [ ] éªŒè¯æ²¡æœ‰å¼•å…¥æ–°é—®é¢˜',
                '- [ ] ç¡®è®¤æ²¡æœ‰åˆ é™¤é‡è¦ä»£ç ',
                '',
                `å…³é—­ #${issueNum}`,
                '',
                '---',
                'ğŸ¤– ç”± Claude Code è‡ªåŠ¨åˆ›å»º'
              ].join('\n'),
              draft: true,
            });

            // åœ¨ issue ä¸­è¯„è®º
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNum,
              body: `ğŸ¤– æˆ‘å·²åˆ›å»ºä¿®å¤ PRï¼ˆè‰ç¨¿ï¼‰: #${pr.number}\n\nè¯· review åå†åˆå¹¶ã€‚`,
            });

