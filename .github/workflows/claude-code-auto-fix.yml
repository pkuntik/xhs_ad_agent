name: Claude Code - å®‰å…¨è‡ªåŠ¨ä¿®å¤

on:
  issues:
    types: [labeled]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  auto-fix:
    # ğŸ”’ å®‰å…¨è®¾è®¡ï¼šå¿…é¡»åŒæ—¶æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶
    # 1. æœ‰ 'auto-fix-approved' æ ‡ç­¾ï¼ˆç”±ç»´æŠ¤è€…æ‰‹åŠ¨æ·»åŠ ï¼‰
    # 2. æœ‰ 'ai-safe' æ ‡ç­¾ï¼ˆè¡¨ç¤ºè¿™æ˜¯ç®€å•ã€å®‰å…¨çš„ä¿®å¤ï¼‰
    if: |
      contains(github.event.issue.labels.*.name, 'auto-fix-approved') &&
      contains(github.event.issue.labels.*.name, 'ai-safe')

    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          # ä½¿ç”¨ GitHub App token è€Œé GITHUB_TOKEN
          # è¿™æ ·åˆ›å»ºçš„ PR å¯ä»¥è§¦å‘å…¶ä»– CI workflow
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: åˆ›å»ºä¿®å¤åˆ†æ”¯
        run: |
          ISSUE_NUM=${{ github.event.issue.number }}
          BRANCH_NAME="auto-fix/issue-${ISSUE_NUM}"
          git checkout -b "$BRANCH_NAME"
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Claude è‡ªåŠ¨ä¿®å¤
        uses: anthropics/claude-code-action@v1
        env:
          # æ”¯æŒè‡ªå®šä¹‰ Anthropic API Base URL
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

          prompt: |
            ä½ æ˜¯è‡ªåŠ¨ä¿®å¤æœºå™¨äººã€‚

            å½“å‰ issue: #${{ github.event.issue.number }}

            âš ï¸ **é‡è¦å®‰å…¨é™åˆ¶**ï¼š
            - åªèƒ½ä¿®å¤ import æ’åºã€ä»£ç æ ¼å¼åŒ–ç­‰**ç®€å•ã€ä½é£é™©**çš„é—®é¢˜
            - ä¸å¾—ä¿®æ”¹ä¸šåŠ¡é€»è¾‘
            - ä¸å¾—ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼ˆ.env, package.json ç­‰ï¼‰
            - ä¸å¾—åˆ é™¤è¶…è¿‡ 50 è¡Œä»£ç 
            - ä¸å¾—åˆ é™¤ console.logï¼ˆå¯èƒ½æ˜¯æœ‰æ„ä¿ç•™çš„ï¼‰

            è¯·ï¼š
            1. ä½¿ç”¨ /issue-manager è¯»å– issue è¯¦æƒ…
            2. æ ¹æ® issue æè¿°è¿›è¡Œä¿®å¤
            3. ä¿®å¤åè¿è¡Œ `pnpm tsc --noEmit` éªŒè¯
            4. å¦‚æœä¿®å¤æˆåŠŸï¼Œæäº¤ä»£ç 

            æäº¤ä¿¡æ¯æ ¼å¼ï¼š
            ```
            fix: [ç®€çŸ­æè¿°]

            Fixes #${{ github.event.issue.number }}

            ğŸ¤– ç”± Claude Code è‡ªåŠ¨ä¿®å¤
            ```

          claude_args: "--max-turns 10"

      - name: æ¨é€åˆ†æ”¯
        run: |
          git push origin "$BRANCH_NAME" || echo "æ²¡æœ‰æ”¹åŠ¨éœ€è¦æ¨é€"

      - name: åˆ›å»º PRï¼ˆå¦‚æœæœ‰æ”¹åŠ¨ï¼‰
        if: success()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNum = ${{ github.event.issue.number }};
            const branchName = process.env.BRANCH_NAME;

            // æ£€æŸ¥åˆ†æ”¯æ˜¯å¦æœ‰æäº¤
            const { data: comparison } = await github.rest.repos.compareCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              base: 'main',
              head: branchName,
            });

            if (comparison.ahead_by === 0) {
              // æ²¡æœ‰æ”¹åŠ¨ï¼Œåœ¨ issue ä¸­è¯´æ˜
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNum,
                body: 'ğŸ¤– æˆ‘åˆ†æäº†è¿™ä¸ªé—®é¢˜ï¼Œä½†æ²¡æœ‰æ‰¾åˆ°å¯ä»¥è‡ªåŠ¨ä¿®å¤çš„ä»£ç ã€‚å¯èƒ½éœ€è¦äººå·¥å¤„ç†ã€‚',
              });
              return;
            }

            // åˆ›å»º PR
            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ¤– è‡ªåŠ¨ä¿®å¤: ${context.payload.issue.title}`,
              head: branchName,
              base: 'main',
              body: `## è‡ªåŠ¨ä¿®å¤

è¿™ä¸ª PR è‡ªåŠ¨ä¿®å¤äº† #${issueNum}ã€‚

âš ï¸ **è¯·ä»”ç»† Review**ï¼š
- [ ] æ£€æŸ¥ä¿®å¤æ˜¯å¦æ­£ç¡®
- [ ] éªŒè¯æ²¡æœ‰å¼•å…¥æ–°é—®é¢˜
- [ ] ç¡®è®¤æ²¡æœ‰åˆ é™¤é‡è¦ä»£ç 

å…³é—­ #${issueNum}

---
ğŸ¤– ç”± Claude Code è‡ªåŠ¨åˆ›å»º`,
              draft: true,  // ğŸ”’ é»˜è®¤åˆ›å»ºä¸ºè‰ç¨¿ PRï¼Œéœ€è¦ç»´æŠ¤è€…æ‰‹åŠ¨ Ready for review
            });

            // åœ¨ issue ä¸­è¯„è®º
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNum,
              body: `ğŸ¤– æˆ‘å·²åˆ›å»ºä¿®å¤ PRï¼ˆè‰ç¨¿ï¼‰: #${pr.number}\n\nè¯· review åå†åˆå¹¶ã€‚`,
            });

