name: Claude Code - è‡ªåŠ¨åŒ–å¼€å‘

on:
  issues:
    types: [labeled]

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write

jobs:
  # ç¬¬ä¸€é˜¶æ®µï¼šæå‡ºå®æ–½æ–¹æ¡ˆ
  propose-fix:
    # ğŸ”’ æ¡ä»¶ï¼šæœ‰ 'auto-fix-approved' å’Œ 'ai-safe'ï¼Œä½†æ²¡æœ‰ 'fix-confirmed'
    if: |
      contains(github.event.issue.labels.*.name, 'auto-fix-approved') &&
      contains(github.event.issue.labels.*.name, 'ai-safe') &&
      !contains(github.event.issue.labels.*.name, 'fix-confirmed')

    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: Claude åˆ†æå¹¶æå‡ºå®æ–½æ–¹æ¡ˆ
        id: propose_solution
        uses: anthropics/claude-code-action@v1
        env:
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

          prompt: |
            ä½ æ˜¯è‡ªåŠ¨åŒ–å¼€å‘æœºå™¨äººã€‚

            å½“å‰ issue: #${{ github.event.issue.number }}

            **ä»»åŠ¡ï¼šåˆ†æé—®é¢˜å¹¶æå‡ºå®æ–½æ–¹æ¡ˆ**

            è¯·ï¼š
            1. ä½¿ç”¨ gh issue view ${{ github.event.issue.number }} è¯»å– issue è¯¦æƒ…
            2. åˆ†æé—®é¢˜å¹¶åˆ¶å®šå®æ–½æ–¹æ¡ˆï¼ˆå¯èƒ½æ˜¯ä¿®å¤ã€æ–°åŠŸèƒ½ã€é‡æ„ç­‰ï¼‰
            3. ä½¿ç”¨ gh issue comment ${{ github.event.issue.number }} --body "..." å‘å¸ƒè¯¦ç»†çš„å®æ–½æ–¹æ¡ˆ

            æ–¹æ¡ˆåº”åŒ…æ‹¬ï¼š
            - é—®é¢˜/éœ€æ±‚åˆ†æ
            - å…·ä½“å®æ–½æ­¥éª¤
            - æ¶‰åŠçš„æ–‡ä»¶å’Œæ¨¡å—
            - é¢„æœŸæ•ˆæœ
            - é£é™©è¯„ä¼°

            åœ¨æ–¹æ¡ˆæœ«å°¾è¯´æ˜ï¼š
            ```
            **æ˜¯å¦åŒæ„æ­¤æ–¹æ¡ˆï¼Ÿ**

            å¦‚æœåŒæ„ï¼Œè¯·åœ¨è¯„è®ºä¸­å›å¤ï¼š
            - è‡ªç„¶è¯­è¨€ï¼š"ä¿®"ã€"åŒæ„"ã€"å¼€å§‹"ã€"å¼€å‘"ï¼ˆAI ä¼šè‡ªåŠ¨ç†è§£ï¼‰
            - æ˜ç¡®æŒ‡ä»¤ï¼š`/confirm-fix` æˆ– `/approve`ï¼ˆå¿«æ·é€šé“ï¼‰

            æˆ‘å°†è‡ªåŠ¨å¼€å§‹æ‰§è¡Œã€‚å¦‚æœä¸åŒæ„ï¼Œè¯·è¯´æ˜è°ƒæ•´è¦æ±‚ã€‚
            ```

            âš ï¸ **é‡è¦**ï¼šæ­¤é˜¶æ®µåªæå‡ºæ–¹æ¡ˆï¼Œä¸è¦å®é™…ç¼–å†™ä»£ç ã€‚

          claude_args: "--max-turns 50 --allowed-tools Read,Grep,Glob,Bash"

      - name: å¤„ç†åˆ†æå¤±è´¥
        if: failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = context.payload.issue.number;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: [
                'âŒ **æ–¹æ¡ˆåˆ†æå¤±è´¥**',
                '',
                'æŠ±æ­‰ï¼Œåˆ†æ issue å¹¶åˆ¶å®šå®æ–½æ–¹æ¡ˆæ—¶é‡åˆ°äº†é—®é¢˜ã€‚',
                '',
                '**å¯èƒ½çš„åŸå› **ï¼š',
                '- é—®é¢˜è¿‡äºå¤æ‚ï¼ŒAI æ— æ³•åˆ†æ',
                '- API è°ƒç”¨å¤±è´¥',
                '- ä»£ç åº“è®¿é—®æƒé™ä¸è¶³',
                '',
                '**å»ºè®®**ï¼š',
                '- è¯·æŸ¥çœ‹ [Actions è¿è¡Œæ—¥å¿—](' + context.payload.repository.html_url + '/actions/runs/' + context.runId + ') äº†è§£è¯¦æƒ…',
                '- ç®€åŒ– issue æè¿°ï¼Œæä¾›æ›´æ˜ç¡®çš„é—®é¢˜è¯´æ˜',
                '- æˆ–è€ƒè™‘æ‰‹åŠ¨ä¿®å¤æ­¤é—®é¢˜',
                '',
                '---',
                'ğŸ¤– GitHub Actions è‡ªåŠ¨é€šçŸ¥'
              ].join('\n')
            });

  # ç¬¬äºŒé˜¶æ®µï¼šæ‰§è¡Œå®æ–½
  execute-fix:
    # ğŸ”’ æ¡ä»¶ï¼šæœ‰å…¨éƒ¨ä¸‰ä¸ªæ ‡ç­¾ï¼ˆauto-fix-approved + ai-safe + fix-confirmedï¼‰
    if: |
      contains(github.event.issue.labels.*.name, 'auto-fix-approved') &&
      contains(github.event.issue.labels.*.name, 'ai-safe') &&
      contains(github.event.issue.labels.*.name, 'fix-confirmed')

    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: åˆ›å»ºå¼€å‘åˆ†æ”¯
        run: |
          ISSUE_NUM=${{ github.event.issue.number }}
          BRANCH_NAME="auto-fix/issue-${ISSUE_NUM}"
          git checkout -b "$BRANCH_NAME"
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Claude æ‰§è¡Œå®æ–½
        id: execute_solution
        uses: anthropics/claude-code-action@v1
        env:
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

          prompt: |
            ä½ æ˜¯è‡ªåŠ¨åŒ–å¼€å‘æœºå™¨äººã€‚

            å½“å‰ issue: #${{ github.event.issue.number }}

            **ä»»åŠ¡ï¼šæ‰§è¡Œå·²ç¡®è®¤çš„æ–¹æ¡ˆ**

            ç”¨æˆ·å·²ç»ç¡®è®¤äº†æ–¹æ¡ˆï¼ˆæœ‰ fix-confirmed æ ‡ç­¾ï¼‰ï¼Œç°åœ¨è¯·æ‰§è¡Œã€‚

            è¯·ï¼š
            1. ä½¿ç”¨ gh issue view ${{ github.event.issue.number }} è¯»å– issue è¯¦æƒ…å’Œè¯„è®º
            2. æŸ¥çœ‹ä¹‹å‰åœ¨è¯„è®ºä¸­å‘å¸ƒçš„æ–¹æ¡ˆï¼ˆä¿®å¤æ–¹æ¡ˆæˆ–å¼€å‘æ–¹æ¡ˆï¼‰
            3. æŒ‰ç…§æ–¹æ¡ˆæ‰§è¡Œï¼š
               - å¦‚æœæ˜¯ä¿®å¤é—®é¢˜ï¼šä¿®å¤ä»£ç 
               - å¦‚æœæ˜¯æ–°åŠŸèƒ½ï¼šç¼–å†™æ–°ä¸šåŠ¡ä»£ç 
               - å¦‚æœæ˜¯é‡æ„ï¼šé‡æ„ä»£ç ç»“æ„
            4. å®Œæˆåè¿è¡Œ `pnpm tsc --noEmit` éªŒè¯ç±»å‹
            5. å¦‚æœå¯èƒ½ï¼Œè¿è¡Œ `pnpm build` ç¡®ä¿æ„å»ºæˆåŠŸ
            6. ä½¿ç”¨ git add å’Œ git commit æäº¤ä»£ç ï¼ˆä¸è¦ pushï¼Œç”±åç»­æ­¥éª¤å¤„ç†ï¼‰

            æäº¤ä¿¡æ¯æ ¼å¼ï¼š
            ```
            <type>: [ç®€çŸ­æè¿°]

            - [è¯¦ç»†æ”¹åŠ¨1]
            - [è¯¦ç»†æ”¹åŠ¨2]

            Fixes #${{ github.event.issue.number }}

            ğŸ¤– ç”± Claude Code è‡ªåŠ¨å®Œæˆ
            ```

            å…¶ä¸­ <type> æ ¹æ®ä»»åŠ¡ç±»å‹é€‰æ‹©ï¼š
            - fix: ä¿®å¤é—®é¢˜
            - feat: æ–°åŠŸèƒ½
            - refactor: é‡æ„
            - docs: æ–‡æ¡£
            - style: ä»£ç æ ¼å¼

          claude_args: "--allowed-tools Read,Grep,Glob,Bash,Edit,Write,TodoWrite"

      - name: æ¨é€åˆ†æ”¯
        run: |
          git push origin "$BRANCH_NAME" || echo "æ²¡æœ‰æ”¹åŠ¨éœ€è¦æ¨é€"

      - name: åˆ›å»º PRï¼ˆå¦‚æœæœ‰æ”¹åŠ¨ï¼‰
        if: success()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNum = ${{ github.event.issue.number }};
            const branchName = process.env.BRANCH_NAME;

            // æ£€æŸ¥åˆ†æ”¯æ˜¯å¦æœ‰æäº¤
            const { data: comparison } = await github.rest.repos.compareCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              base: 'main',
              head: branchName,
            });

            if (comparison.ahead_by === 0) {
              // æ²¡æœ‰æ”¹åŠ¨ï¼Œåœ¨ issue ä¸­è¯´æ˜
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNum,
                body: 'ğŸ¤– æˆ‘åˆ†æäº†è¿™ä¸ªé—®é¢˜ï¼Œä½†æ²¡æœ‰æ‰¾åˆ°éœ€è¦æ”¹åŠ¨çš„ä»£ç ã€‚å¯èƒ½éœ€è¦äººå·¥å¤„ç†ã€‚',
              });
              return;
            }

            // åˆ›å»º PR
            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ¤– è‡ªåŠ¨å®æ–½: ${context.payload.issue.title}`,
              head: branchName,
              base: 'main',
              body: [
                '## è‡ªåŠ¨å®æ–½',
                '',
                `è¿™ä¸ª PR è‡ªåŠ¨å®æ–½äº† #${issueNum}ã€‚`,
                '',
                'âš ï¸ **è¯·ä»”ç»† Review**ï¼š',
                '- [ ] æ£€æŸ¥å®æ–½æ˜¯å¦æ­£ç¡®',
                '- [ ] éªŒè¯æ²¡æœ‰å¼•å…¥æ–°é—®é¢˜',
                '- [ ] ç¡®è®¤ä»£ç è´¨é‡ç¬¦åˆè¦æ±‚',
                '',
                `å…³é—­ #${issueNum}`,
                '',
                '---',
                'ğŸ¤– ç”± Claude Code è‡ªåŠ¨åˆ›å»º'
              ].join('\n'),
              draft: true,
            });

            // åœ¨ issue ä¸­è¯„è®º
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNum,
              body: `ğŸ¤– æˆ‘å·²åˆ›å»ºå®æ–½ PRï¼ˆè‰ç¨¿ï¼‰: #${pr.number}\n\nè¯· review åå†åˆå¹¶ã€‚`,
            });

      - name: å¤„ç†æ‰§è¡Œå¤±è´¥
        if: failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = context.payload.issue.number;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: [
                'âŒ **è‡ªåŠ¨å®æ–½å¤±è´¥**',
                '',
                'æŠ±æ­‰ï¼Œæ‰§è¡Œæ–¹æ¡ˆæ—¶é‡åˆ°äº†é—®é¢˜ã€‚',
                '',
                '**å¯èƒ½çš„åŸå› **ï¼š',
                '- ä»£ç ä¿®æ”¹å¤±è´¥ï¼ˆè¯­æ³•é”™è¯¯ã€ç±»å‹é”™è¯¯ç­‰ï¼‰',
                '- æ„å»ºæˆ–æµ‹è¯•éªŒè¯å¤±è´¥',
                '- Git æ“ä½œå¤±è´¥',
                '- API è°ƒç”¨è¶…æ—¶æˆ–å¤±è´¥',
                '',
                '**å»ºè®®**ï¼š',
                '- è¯·æŸ¥çœ‹ [Actions è¿è¡Œæ—¥å¿—](' + context.payload.repository.html_url + '/actions/runs/' + context.runId + ') äº†è§£è¯¦æƒ…',
                '- æ£€æŸ¥æ˜¯å¦éœ€è¦è°ƒæ•´å®æ–½æ–¹æ¡ˆ',
                '- æˆ–è€ƒè™‘æ‰‹åŠ¨å¤„ç†æ­¤é—®é¢˜',
                '',
                '---',
                'ğŸ¤– GitHub Actions è‡ªåŠ¨é€šçŸ¥'
              ].join('\n')
            });

